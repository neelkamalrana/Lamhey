name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # Update system packages
          sudo apt update -y
          
          # Install Node.js 18 if not present
          if ! command -v node &> /dev/null || [ "$(node -v | cut -d'v' -f2 | cut -d'.' -f1)" -lt "18" ]; then
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
          fi
          
          # Install PM2 if not present
          if ! command -v pm2 &> /dev/null; then
            sudo npm install -g pm2
          fi
          
          # Install Nginx if not present
          if ! command -v nginx &> /dev/null; then
            sudo apt install -y nginx
          fi
          
          # Navigate to application directory
          cd /home/ubuntu
          
          # Remove existing deployment
          sudo rm -rf Lamhey
          
          # Clone latest code
          git clone https://github.com/neelkamalrana/Lamhey.git
          cd Lamhey
          
          # Install dependencies
          npm run install:all
          
          # Set up environment variables (single .env approach)
          echo "REACT_APP_COGNITO_USER_POOL_ID=us-east-2_GOHDcj0J4" > client/.env
          echo "REACT_APP_COGNITO_CLIENT_ID=v3be3ikb1s1d6eaaulkvbv5f1" >> client/.env
          echo "REACT_APP_COGNITO_REGION=us-east-2" >> client/.env
          echo "REACT_APP_COGNITO_DOMAIN=us-east-2gohdcj0j4.auth.us-east-2.amazoncognito.com" >> client/.env
          echo "REACT_APP_COGNITO_REDIRECT_SIGNIN=https://lamhey.co/callback" >> client/.env
          echo "REACT_APP_COGNITO_REDIRECT_SIGNOUT=https://lamhey.co/" >> client/.env
          echo "REACT_APP_COGNITO_SCOPES=email openid phone" >> client/.env
          echo "REACT_APP_COGNITO_RESPONSE_TYPE=code" >> client/.env
          echo "REACT_APP_COGNITO_HOSTED_UI_URL=https://us-east-2gohdcj0j4.auth.us-east-2.amazoncognito.com/login?client_id=v3be3ikb1s1d6eaaulkvbv5f1&response_type=code&scope=email+openid+phone&redirect_uri=https%3A%2F%2Flamhey.co%2Fcallback" >> client/.env
          
          # Build application
          npm run build:all
          
          # Configure Nginx
          sudo cp nginx.conf /etc/nginx/nginx.conf
          sudo nginx -t
          sudo systemctl restart nginx
          sudo systemctl enable nginx
          
          # Stop existing PM2 processes
          pm2 stop all 2>/dev/null || true
          pm2 delete all 2>/dev/null || true
          
          # Start application with PM2
          pm2 start server/server.js --name "lamhey" --env production
          pm2 startup
          pm2 save
          
          # Configure firewall
          sudo ufw allow 22 2>/dev/null || true
          sudo ufw allow 80 2>/dev/null || true
          sudo ufw allow 443 2>/dev/null || true
          sudo ufw --force enable 2>/dev/null || true
          
          # Health check
          sleep 5
          if pm2 list | grep -q "lamhey.*online"; then
            echo "✅ Deployment successful!"
            echo "🌐 Application is running at: http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)"
          else
            echo "❌ Deployment failed!"
            pm2 logs lamhey --lines 20
            exit 1
          fi